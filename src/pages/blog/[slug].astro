---
import Layout from '../../layouts/Layout.astro';
import { siteConfig } from '../../config/content';
import { marked } from 'marked';

export async function getStaticPaths() {
  const STRAPI_URL = import.meta.env.STRAPI_URL || 'http://localhost:1337';
  
  const response = await fetch(`${STRAPI_URL}/api/posts?populate=*`);
  const { data } = await response.json();
  
  console.log('==========================================');
  console.log('Building static paths for:', data?.length || 0, 'posts');
  
  if (!data || data.length === 0) {
    console.warn('No posts found for static paths');
    return [];
  }

  // Debug: Log the first post to see structure
  if (data.length > 0) {
    console.log('First post:', JSON.stringify(data[0], null, 2));
  }

  const paths = data
    .filter((post: any) => {
      // Access slug directly, not through attributes
      const slug = post?.slug || post?.attributes?.slug;
      
      if (!slug) {
        console.warn('Post missing slug:', post);
      }
      
      return slug;
    })
    .map((post: any) => {
      // Handle both flat and nested structures
      const slug = post.slug || post.attributes?.slug;
      console.log('Creating path for slug:', slug);
      
      return {
        params: { slug },
        props: { post },
      };
    });

  console.log('Total paths created:', paths.length);
  console.log('==========================================');
  
  return paths;
}

type Props = {
  post: any;
};

const { post } = Astro.props;
const attrs = post.attributes || post;

// Define STRAPI_URL again for use in the template
const STRAPI_URL = import.meta.env.STRAPI_URL || 'http://localhost:1337';

// Extract all data
const title = attrs.title;
const excerpt = attrs.excerpt;
const content = attrs.content;
const category = attrs.category || 'Insights';
const readTime = attrs.readTime || '5 min read';
const date = attrs.date;
const cover = attrs.cover;
const tags = attrs.tags || [];

const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// ✅ UPDATED: Handle both Strapi v3 and v4 structures
const coverUrl = cover?.url || cover?.data?.attributes?.url;
const coverAlt = cover?.alternativeText || cover?.data?.attributes?.alternativeText || title;

// Helper function
function getStrapiMedia(url: string | null | undefined): string {
  if (!url) return '';
  if (url.startsWith('http') || url.startsWith('//')) return url;
  return `${STRAPI_URL}${url}`;
}

// Convert Markdown to HTML
const htmlContent = marked(content);
---

<Layout title={`${siteConfig.name} | ${title}`}>
  <article class="pt-24 pb-20 lg:pt-32 bg-white article-page">
    
    <!-- Header Section -->
    <div class="max-w-4xl mx-auto px-6 lg:px-8 mb-16 article-header">
      
      <!-- Meta Information -->
      <div class="mb-6">
        <p class="text-[#0eb4b3] text-xs font-mono font-bold tracking-[0.15em] uppercase">
          {category} • {readTime}
        </p>
      </div>
      
      <!-- Title -->
      <h1 class="text-4xl lg:text-5xl font-bold text-[#0b1430] mb-6 leading-tight">
        {title}
      </h1>
      
      <!-- Published Date -->
      <p class="text-[#636562] text-sm mb-8">
        Published {formattedDate}
      </p>
      
      <!-- Cover Image -->
      {coverUrl && (
        <div class="mb-8">
          <img 
            src={getStrapiMedia(coverUrl)} 
            alt={coverAlt}
            class="w-full rounded-lg shadow-md"
          />
        </div>
      )}
      
      <!-- Excerpt/Summary -->
      <div class="bg-gray-50 border-l-4 border-[#0eb4b3] p-6">
        <p class="text-lg text-[#636562] leading-relaxed">
          {excerpt}
        </p>
      </div>
    </div>

    <!-- Separator -->
    <div class="max-w-4xl mx-auto px-6 lg:px-8 mb-12 article-separator">
      <div class="border-t border-gray-200"></div>
    </div>
    
    <!-- Content Section -->
    <div class="max-w-4xl mx-auto px-6 lg:px-8 article-content-wrapper">
      
      <!-- Article Content -->
      <div class="blog-content prose prose-lg max-w-none
        prose-headings:font-bold prose-headings:text-[#0b1430]
        prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:pb-3 prose-h2:border-b-2 prose-h2:border-[#0eb4b3]
        prose-h3:text-xl prose-h3:mt-10 prose-h3:mb-4 prose-h3:text-[#0b1430]
        prose-h4:text-lg prose-h4:mt-8 prose-h4:mb-3 prose-h4:font-semibold prose-h4:text-[#0b1430]
        prose-p:text-[#636562] prose-p:leading-[1.8] prose-p:mb-6 prose-p:text-base
        prose-a:text-[#0eb4b3] prose-a:font-medium prose-a:no-underline hover:prose-a:underline hover:prose-a:text-[#0b1430]
        prose-strong:text-[#0b1430] prose-strong:font-bold
        prose-ul:my-8 prose-ul:space-y-3 prose-ul:list-none prose-ul:pl-0
        prose-ol:my-8 prose-ol:space-y-3 prose-ol:pl-0
        prose-li:text-[#636562] prose-li:leading-relaxed prose-li:relative
        prose-blockquote:border-l-4 prose-blockquote:border-[#0eb4b3] prose-blockquote:bg-gray-50 prose-blockquote:pl-6 prose-blockquote:py-4 prose-blockquote:my-8 prose-blockquote:italic prose-blockquote:text-[#636562]
        prose-code:text-[#0eb4b3] prose-code:bg-gray-100 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:text-sm prose-code:font-mono prose-code:font-semibold
        prose-pre:bg-[#0b1430] prose-pre:text-white prose-pre:p-6 prose-pre:rounded-lg prose-pre:overflow-x-auto prose-pre:my-8
        prose-hr:border-gray-200 prose-hr:my-12
        prose-img:rounded-lg prose-img:shadow-md prose-img:my-8
      " set:html={htmlContent}>
      </div>
      
      <!-- Tags Section -->
      {tags && tags.length > 0 && (
        <div class="mt-16 pt-8 border-t border-gray-200 article-tags">
          <p class="text-sm font-semibold text-[#0b1430] mb-4 uppercase tracking-wider">Topics</p>
          <div class="flex flex-wrap gap-3">
            {tags.map((tag: string) => (
              <span class="bg-white border-2 border-gray-200 text-[#636562] px-4 py-2 rounded-lg text-xs font-mono font-semibold uppercase tracking-wider hover:border-[#0eb4b3] hover:text-[#0eb4b3] transition-all cursor-pointer">
                {tag}
              </span>
            ))}
          </div>
        </div>
      )}
      
      <!-- Back Link -->
      <div class="mt-12 pt-8 border-t border-gray-200 article-back-link">
        <a 
          href="/blog" 
          class="text-[#0eb4b3] hover:text-[#0b1430] font-semibold text-sm inline-flex items-center gap-2 transition-colors group"
        >
          <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to all articles
        </a>
      </div>
      
    </div>
  </article>
</Layout>

<style is:global>
  .blog-content ul li {
    padding-left: 1.75rem;
  }
  
  .blog-content ul li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: #0eb4b3;
    font-weight: bold;
    font-size: 1.25rem;
  }
  
  .blog-content ul li:has(strong:first-child)::before {
    content: '';
  }
  
  .blog-content ul li:has(strong:first-child) {
    padding-left: 0;
  }
  
  .blog-content ol li {
    padding-left: 1.75rem;
    margin-left: 1.5rem;
  }
  
  .blog-content ol li::marker {
    color: #0eb4b3;
    font-weight: bold;
  }
  
  .blog-content ol li:has(strong:first-child) {
    list-style-type: none;
    padding-left: 0;
    margin-left: 0;
  }
</style>

<style>
  html {
    scroll-behavior: smooth;
  }
  
  .article-page {
    opacity: 0;
    animation: fadeInUp 0.8s ease-out forwards;
  }
  
  .article-header {
    opacity: 0;
    animation: fadeInUp 0.8s ease-out 0.2s forwards;
  }
  
  .article-separator {
    opacity: 0;
    animation: fadeInUp 0.6s ease-out 0.4s forwards;
  }
  
  .article-content-wrapper {
    opacity: 0;
    animation: fadeInUp 0.8s ease-out 0.5s forwards;
  }
  
  .article-tags {
    opacity: 0;
    animation: fadeInUp 0.6s ease-out 0.7s forwards;
  }
  
  .article-back-link {
    opacity: 0;
    animation: fadeInUp 0.6s ease-out 0.8s forwards;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
